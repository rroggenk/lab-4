---
title: "Global Health Monitor Dashboard"
format:
  dashboard:
    theme: cosmo 
    logo: images/Wellcome_Trust_logo.png
    orientation: columns
    nav-tabs: true
    nav-buttons:
    - icon: github
      href: https://github.com/rroggenk/
      aria-label: GitHub
    - icon: linkedin
      href: https://www.linkedin.com/in/rroggenk/
      aria-label: LinkedIn
    - icon: envelope
      href: rroggenk@calpoly.edu
      aria-label: Email
---


```{r}
#| label: setup
#| message: false
#| warning: false
#| include: false 


# Load Libraries
library(tidyverse)
library(readxl)
library(here)
library(scales)
library(plotly)
library(leaflet)
library(maps)
library(sf)
library(geojsonio)
library(DT) 
library(ggrepel) 

# --- Data Loading and Prep Code (adapted from Lab 3) ---

# Data for Cards
vaccine_data_card <- read.csv("/Users/rachelroggenkemper/Documents/STAT541/Labs/Lab4/data/vaccine_data_card.csv")
vaccine_plot_data_card <- read.csv("/Users/rachelroggenkemper/Documents/STAT541/Labs/Lab4/data/vaccine_plot_data_card.csv")
# Simple mean of country averages (not population weighted)
# Use the 'vaccine_safe' average from vaccine_data
global_avg_safe <- mean(vaccine_data_card$vaccine_safe, na.rm = TRUE) 
# Use the 'disagree_effective_pct' average from vaccine_plot_data
global_avg_disagree_effective <- mean(vaccine_plot_data_card$disagree_effective_pct, na.rm = TRUE)


# Data for Plot 1
vaccine_data <- read.csv("/Users/rachelroggenkemper/Documents/STAT541/Labs/Lab4/data/vaccine_data.csv")

# Data for Plot 2
vaccine_plot_data <- read.csv("/Users/rachelroggenkemper/Documents/STAT541/Labs/Lab4/data/vaccine_plot_data.csv")

# Data for Plot 3
health_data <- read.csv("/Users/rachelroggenkemper/Documents/STAT541/Labs/Lab4/data/health_data.csv")

```

# Vaccine Views

## Column {width=20%}

### Row {height=50%}

::: {.valuebox icon="shield-check" color="info"} 
Global Avg: Agree Safe

`r scales::percent(global_avg_safe, accuracy = 0.1)` 
:::

### Row {height=50%}

::: {.valuebox icon="shield-x" color="danger"}
Global Avg: Disagree Effective

`r scales::percent(global_avg_disagree_effective, accuracy = 0.1)`
:::

## Column {width=80%}

### Perceptions {.tabset}

::: {.card title="Vaccine Safety Perception by Region"}
```{r}
#| label: plot-vaccine-safety-lab2
#| title: "Percentage of People who Believe Vaccines are Safe, by Country and Global Region" 
#| fig-height: 6 

vaccine_data %>%
  ggplot(aes(y = reorder(global_region, region_median), 
             x = vaccine_safe, 
             color = global_region)) +
    geom_point(aes(alpha = 0.78, 
                   size = 3)) +
    geom_errorbar(aes(y = global_region, 
                      xmax = region_median, 
                      xmin = region_median),
                  size = 0.5, 
                  linetype = "solid", 
                  width = 1, 
                  color = "black") +
    scale_color_manual(values = c("skyblue1", "seagreen4", "yellow2",
                                  "orangered4", "salmon1", "dodgerblue4")) +
    geom_linerange(aes(xmin = region_median, 
                       xmax = region_median,
                       group = global_region)) +
    labs(x = NULL, 
         y = NULL,
         title = "Percentage of People who Believe Vaccines are Safe,
         \nby Country and Global Region") +
    theme_bw() +
    theme(legend.position = "none",
          panel.grid.major.y = element_blank(),
          panel.grid.minor.y = element_blank(),
          axis.ticks.y = element_blank(),
          axis.text.y = element_blank(),
          plot.title = element_text(face = 'bold')) +
    scale_x_continuous(breaks = seq(0.2, 1, by = 0.1),
                       labels = label_percent(),
                       sec.axis = dup_axis()) +
    guides(color = FALSE) +
    geom_text(aes(y = global_region, x = 0.2, label = global_region), 
              vjust = -1,
              hjust = 0,
              size = 4,
              fontface = "bold") +
    geom_text(aes(label = min_max),
                    vjust = 0,
                    hjust = 0,
                    size = 3,
                    color = "gray18") +
    annotate(geom = "text",
             x = 0.865, 
             y = "Asia", 
             label = "Regional Median",
             color = "black", 
             size = 2.5,
             hjust = 0,
             vjust = -3)
```
:::

::: {.card title="Safety vs. Effectiveness Disagreement"}
```{r}
#| label: plot-safety-vs-effectiveness-lab2
#| title: "Scatterplot exploring people's perceptions of vaccine safety and vaccine effectiveness"

# Compiling vaccine safety/effectiveness data 
vaccine_plot <- vaccine_plot_data %>%
  ggplot(aes(x = disagree_safe, y = disagree_effective)) +
  geom_point(aes(text = paste0("Country: ", country, "<br>",
                               "Disagree vaccines are safe: ", 
                               round(disagree_safe * 100, 2), "%<br>",
                               "Disagree vaccines are effective: ", 
                               round(disagree_effective * 100, 2), "%")),
             color = "skyblue1", shape = 15, size = 1.8) +
  geom_smooth(method = "lm", se = FALSE, color = "yellow2", linewidth = 0.8) +
  theme_bw() +
  scale_x_continuous(breaks = seq(0, 1, by = 0.1),
                     labels = label_percent()) +
  scale_y_continuous(breaks = seq(0, 1, by = 0.1),
                     labels = label_percent()) +    
  labs(x = NULL,
       y = NULL)

# Turn into interactive plotly plot
ggplotly(vaccine_plot, tooltip = "text") %>%
  layout(title = list(text = paste0("Scatterplot exploring people's perceptions of vaccine safety <br> and vaccine effectiveness",
                                    "<br><sup>Percentage of people who disagree that vaccines are safe by percentage of people who <br> disagree that vaccines are effective</sup>"),
                      x = 0.01,  
                      xanchor = "left"),
         margin = list(t = 150))
```
:::

# Health Interest

## Column {width=65%}

::: {.card title="Map of interest in learning more about medicine, disease, or health by country"}
```{r}
#| label: map-health-interest-lab2
#| title: "Map of interest in learning more about medicine, disease, or health by country"

# # Leaflet Map
# pallatte <- colorNumeric("plasma", domain = health_data_json$percentage)
# 
# leaflet(health_data_json) %>%
#   setView(lng = 0, lat = 0, zoom = 1) %>%
#   addPolygons(stroke = FALSE, 
#               smoothFactor = 0.2, 
#               fillOpacity = 1,
#               color = ~pallatte(percentage),
#               label = paste0(health_data_json$country, ": ", 
#                              round(health_data_json$percentage, 1), "%"),
#               highlightOptions = highlightOptions(weight = 5,
#                                                   color = "#000000",
#                                                   fillOpacity = 0.7)) %>%
#   addLegend(pallatte, 
#             values = ~percentage,
#             opacity = 0.8,
#             title = "Interest level (%)",
#             position = "bottomleft",
#             labFormat = labelFormat(suffix = "%")) %>%
#   addControl(html = "<div class='map-title'>Map of interest in learning more about medicine,<br>disease, or health by country</div>",
#              position = "topright")
```
:::
