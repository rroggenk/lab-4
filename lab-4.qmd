---
title: "Global Health Monitor Dashboard"
format:
  dashboard:
    theme: cosmo 
    logo: images/Wellcome_Trust_logo.png # Replace with your logo file path if needed
    orientation: columns
    nav-tabs: true
    nav-buttons:
    - icon: github
      href: https://github.com/rroggenk/ 
      aria-label: GitHub
    - icon: linkedin
      href: https://www.linkedin.com/in/rroggenk/ 
      aria-label: LinkedIn
    - icon: envelope
      href: mailto:rroggenk@calpoly.edu 
      aria-label: Email
server: shiny 
---


```{r}
#| label: setup
#| context: setup 
#| message: false
#| warning: false
#| include: false 

# Load Libraries
library(shiny) 
library(bslib) # <<< ADDED: For bslib::value_box
library(tidyverse)
library(scales)
library(plotly)
library(DT) 
library(ggrepel) # <<< ADDED: For geom_text_repel

# --- Data Loading and Prep Code ---

# Data for Cards 
vaccine_plot_data_card <- read.csv("/Users/rachelroggenkemper/Documents/STAT541/Labs/Lab4/data/vaccine_plot_data_card.csv")

# Data for Plot 1 (also used for dynamic card)
vaccine_data <- read.csv("/Users/rachelroggenkemper/Documents/STAT541/Labs/Lab4/data/vaccine_data.csv")

# Data for Plot 2
vaccine_plot_data <- read.csv("/Users/rachelroggenkemper/Documents/STAT541/Labs/Lab4/data/vaccine_plot_data.csv")

# Data for Interactive Table
health_data <- read.csv("/Users/rachelroggenkemper/Documents/STAT541/Labs/Lab4/data/health_data.csv")

# Initial calculation for the second (static) card
global_avg_disagree_effective <- mean(vaccine_plot_data_card$disagree_effective_pct, na.rm = TRUE)

# Get unique regions for checkbox input
unique_regions <- unique(vaccine_data$global_region)
# Ensure regions are sorted or in a desired order if necessary
unique_regions <- sort(unique_regions) 
```

# Vaccine Views

## {.sidebar}
```{r}
#| label: region-checkboxes
# Checkbox input for regions
checkboxGroupInput("selected_regions", 
                   "Select Regions to Display:",
                   choices = unique_regions,
                   selected = unique_regions) # Default to all selected
```

## Column {width=75%}
### Row {height=25%}

#### Card 1 {width=50%}
```{r}
#| label: safe-avg-output
# Placeholder for the dynamic value box UI
uiOutput("safe_avg_card") 
```


```{r}
#| label: safe-avg-calculation
#| context: server 
# Server logic to calculate average and render the dynamic value box for Card 1

output$safe_avg_card <- renderUI({
  req(input$selected_regions) # Ensure regions are selected
  
  # Filter vaccine_data based on selected regions
  filtered_data <- vaccine_data %>%
    filter(global_region %in% input$selected_regions)
  
  # Handle case where no data remains after filtering
  if (nrow(filtered_data) == 0) {
    # Return a placeholder or minimal value box if no regions selected
     value_box(
        title = "Avg: Agree/Strongly Agree Safe", # <<< MODIFIED: Clarified title
        value = "N/A",
        showcase = bsicons::bs_icon("shield-slash"), # Indicate issue
        theme_color = "secondary" 
     )
  } else {
      # Calculate the mean for the filtered data
      mean_val <- mean(filtered_data$vaccine_safe, na.rm = TRUE)
      
      # Determine color based on the mean value
      box_color <- case_when(
        mean_val >= 0.85 ~ "success", # Green for high agreement (>=85%)
        mean_val >= 0.70 ~ "info",    # Blue for medium agreement (>=70%)
        TRUE             ~ "warning"  # Orange for lower agreement (<70%)
      )
      
      # Construct the dynamic value box using bslib::value_box
      value_box(
        title = "Avg: Agree/Strongly Agree Safe (Selected Regions)", # <<< MODIFIED: Clarified title
        value = scales::percent(mean_val, accuracy = 0.1),
        showcase = bsicons::bs_icon("shield-check"), # Use bsicons helper
        theme_color = box_color # Use dynamic color
      )
  }
})

```

#### Card 2 {width=50%}
::: {.valuebox icon="shield-x" color="danger"}
Global Avg: Disagree Effective
`r scales::percent(global_avg_disagree_effective, accuracy = 0.1)` 
:::

### Row {height=75%}

#### Perceptions {.tabset}

::: {.card title="Vaccine Safety Perception by Region"}

```{r}
#| label: plot-vaccine-safety-output
# Placeholder for the dynamic plot
plotOutput("vaccine_safety_plot") 
```{r}
#| label: plot-vaccine-safety-render
#| context: server 
# Server logic to render the dynamic plot

output$vaccine_safety_plot <- renderPlot({
  req(input$selected_regions) # Ensure regions are selected
  
  # Filter data based on selected regions
  plot_data_filtered <- vaccine_data %>%
    filter(global_region %in% input$selected_regions)
  
  # Check if any data remains after filtering
  if (nrow(plot_data_filtered) == 0) {
    plot(NULL, xlim=c(0,1), ylim=c(0,1), ann=FALSE, axes=FALSE)
    text(0.5, 0.5, "Please select at least one region.")
    return() 
  }

  # Using a named color vector for robustness
  region_colors <- setNames(
      c("skyblue1", "seagreen4", "yellow2", "orangered4", "salmon1", "dodgerblue4"),
      sort(unique(vaccine_data$global_region)) 
  )
  plot_colors <- region_colors[names(region_colors) %in% input$selected_regions]

  # Determine factor levels based on the full dataset's median
  ordered_levels <- levels(reorder(vaccine_data$global_region, vaccine_data$region_median))
  plot_levels <- ordered_levels[ordered_levels %in% input$selected_regions]
  
  plot_data_filtered %>%
    mutate(global_region = factor(global_region, levels = plot_levels)) %>%
    ggplot(aes(y = global_region, 
               x = vaccine_safe, 
               color = global_region)) +
    geom_point(aes(alpha = 0.78), size = 3, show.legend = FALSE) + 
    geom_errorbar(aes(y = global_region, 
                      xmax = region_median, 
                      xmin = region_median),
                  size = 0.5, 
                  linetype = "solid", 
                  width = 0.5, 
                  color = "black") +
    scale_color_manual(values = plot_colors) + 
    labs(x = NULL, 
         y = NULL,
         # <<< MODIFIED: Clarified title
         title = "Percentage Agreeing/Strongly Agreeing Vaccines are Safe,\nby Country and Selected Global Region(s)") + 
    theme_bw() +
    theme(legend.position = "none",
          panel.grid.major.y = element_blank(),
          panel.grid.minor.y = element_blank(),
          axis.ticks.y = element_blank(),
          axis.text.y = element_blank(), 
          plot.title = element_text(face = 'bold')) +
    scale_x_continuous(breaks = seq(0.2, 1, by = 0.1),
                       labels = label_percent(),
                       limits = c(0.15, 1.05), 
                       oob = scales::rescale_none) + 
    guides(color = "none") + 
    # Add region labels 
    geom_text(aes(y = global_region, x = 0.18, label = global_region), 
              hjust = 0,
              size = 4,
              fontface = "bold",
              check_overlap = FALSE, 
              show.legend = FALSE) + 
    # <<< MODIFIED: Use geom_text_repel for min/max labels
    ggrepel::geom_text_repel(
              data = . %>% filter(!is.na(min_max)), # Only plot where min_max exists
              aes(label = min_max), 
              size = 3, 
              color = "gray18",
              show.legend = FALSE,
              # ggrepel adjustments
              box.padding = 0.4, # Increase padding around text
              point.padding = 0.2, # Padding around the point it's labeling
              segment.color = 'grey50', # Color of line segment
              segment.size = 0.3,     # Thickness of line segment
              min.segment.length = 0, # Draw segments even if short
              force = 10,             # Increase repel force
              max.overlaps = Inf      # Allow more overlaps if needed (adjust force first)
              ) +
    coord_cartesian(clip = "off") # Allow text outside plot area

}, res = 96) 

```
:::

::: {.card title="Safety vs. Effectiveness Disagreement"}

This scatterplot explores the relationship between the percentage of people in a country who disagree that vaccines are safe and the percentage who disagree that they are effective. Each point represents a country.

```{r}
#| label: plot-safety-vs-effectiveness-lab2
#| title: "Relationship between Disagreement on Vaccine Safety and Effectiveness" # <<< MODIFIED: Shortened plotly title

# This plot remains static (non-reactive)

# Compiling vaccine safety/effectiveness data 
vaccine_plot <- vaccine_plot_data %>%
  ggplot(aes(x = disagree_safe, y = disagree_effective)) +
  geom_point(aes(text = paste0("Country: ", country, "<br>",
                               "Disagree vaccines are safe: ", 
                               round(disagree_safe * 100, 2), "%<br>",
                               "Disagree vaccines are effective: ", 
                               round(disagree_effective * 100, 2), "%")),
             color = "skyblue1", shape = 15, size = 1.8) +
  geom_smooth(method = "lm", se = FALSE, color = "yellow2", linewidth = 0.8) +
  theme_bw() +
  scale_x_continuous(breaks = seq(0, 1, by = 0.1),
                     labels = label_percent()) +
  scale_y_continuous(breaks = seq(0, 1, by = 0.1),
                     labels = label_percent()) +   
  labs(x = "Disagree Vaccines are Safe (%)", # Added axis labels for clarity
       y = "Disagree Vaccines are Effective (%)") 

# Turn into interactive plotly plot
ggplotly(vaccine_plot, tooltip = "text") %>%
  # <<< MODIFIED: Simplified layout title, removed subtitle
  layout(title = list(text = "Country-Level Vaccine Disagreement: Safety vs. Effectiveness", 
                      x = 0.01,  
                      xanchor = "left"),
         margin = list(t = 80)) # Reduced top margin
```
:::

# Health Interest

## {.sidebar}
```{r}
#| label: health-interest-slider
# Slider input for health interest percentage

# Determine range from data
min_interest <- floor(min(health_data$percentage, na.rm = TRUE)) 
max_interest <- ceiling(max(health_data$percentage, na.rm = TRUE))

sliderInput("interest_threshold", 
            "Minimum % Interested in Health Info:",
            min = min_interest, 
            max = max_interest, 
            value = max(min_interest, min(max_interest, round((min_interest + max_interest) / 2))), 
            step = 1,
            post = "%") 
```

## Column {width=75%}
::: {.card title="Countries by Interest in Health Information"}

```{r}
#| label: health-table-output
# Placeholder for the dynamic table
DTOutput("health_table")
```


```{r}
#| label: health-table-render
#| context: server
# Server logic to render the dynamic DT table

output$health_table <- renderDT({
  req(input$interest_threshold) # Ensure slider value is available
  
  # Filter health data based on slider input
  filtered_health_data <- health_data %>%
    filter(percentage >= input$interest_threshold) %>%
    select(Country = country, `Interest Percentage` = percentage) %>%
    # <<< Reverted to descending sort as per previous version
    arrange(`Interest Percentage`)
  
  # Create the datatable
  datatable(filtered_health_data,
            rownames = FALSE, 
            options = list(
              pageLength = 10, 
              autoWidth = TRUE,
              # <<< Reverted to ascending sort order
              order = list(list(1, 'asc')), 
              columnDefs = list(
                  list(className = 'dt-center', targets = "_all") 
              ) 
            )) %>%
    formatRound('Interest Percentage', digits = 1) 

})
```
:::

